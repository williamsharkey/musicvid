<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>musicvid</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  background: #0a0a0a;
  color: #e0e0e0;
  overflow-x: hidden;
}

/* Top bar */
#topbar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: #111;
  border-bottom: 1px solid #222;
  position: sticky;
  top: 0;
  z-index: 100;
}
#topbar h1 { font-size: 14px; color: #888; font-weight: normal; }
#topbar .song-title { color: #fff; font-weight: bold; }
#topbar button {
  background: #222;
  border: 1px solid #333;
  color: #ccc;
  padding: 4px 12px;
  cursor: pointer;
  font-family: inherit;
  font-size: 12px;
}
#topbar button:hover { background: #333; color: #fff; }
/* Step indicators */
#step-indicators {
  display: flex;
  gap: 4px;
  margin-left: auto;
}
.step-indicator {
  padding: 2px 8px;
  font-size: 10px;
  border-radius: 3px;
  background: #222;
  color: #555;
}
.step-indicator.done {
  background: #1a3a1a;
  color: #4a4;
}
.step-indicator.active {
  background: #3a3a1a;
  color: #aa4;
}

/* Toolbar */
#toolbar {
  display: flex;
  gap: 6px;
  padding: 8px 16px;
  background: #0d0d0d;
  border-bottom: 1px solid #222;
  flex-wrap: wrap;
}
.tool-btn {
  background: #1a1a1a;
  border: 1px solid #333;
  color: #888;
  padding: 6px 12px;
  cursor: pointer;
  font-family: inherit;
  font-size: 11px;
  border-radius: 3px;
}
.tool-btn:hover { background: #252525; color: #aaa; }
.tool-btn.active { background: #1a2a3a; border-color: #2a5a8a; color: #8af; }
.tool-btn.action-btn {
  background: #2a2a1a;
  border-color: #4a4a2a;
  color: #aa8;
}
.tool-btn.action-btn:hover { background: #3a3a2a; color: #cc9; }
.tool-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Setup panel */
#setup-panel {
  padding: 24px;
  max-width: 600px;
}
#setup-panel h2 { font-size: 16px; margin-bottom: 16px; color: #aaa; }
#setup-panel label { display: block; margin: 12px 0 4px; color: #888; font-size: 12px; }
#setup-panel input, #setup-panel textarea {
  width: 100%;
  background: #111;
  border: 1px solid #333;
  color: #e0e0e0;
  padding: 8px;
  font-family: inherit;
  font-size: 13px;
}
#setup-panel textarea { min-height: 150px; resize: vertical; }
#setup-panel .row { display: flex; gap: 12px; }
#setup-panel .row > div { flex: 1; }

/* Audio controls */
#audio-bar {
  padding: 8px 16px;
  background: #0d0d0d;
  border-bottom: 1px solid #1a1a1a;
  display: none;
  align-items: center;
  gap: 12px;
}
#audio-bar audio { height: 28px; flex: 1; }
#audio-bar .time { font-size: 11px; color: #666; min-width: 60px; }

/* Timeline */
#timeline-container {
  padding: 16px;
  display: none;
}
#timeline-label {
  font-size: 11px;
  color: #555;
  margin-bottom: 6px;
}
#timeline {
  display: flex;
  align-items: stretch;
  min-height: 60px;
  overflow-x: auto;
  overflow-y: hidden;
  border: 1px solid #222;
  background: #0d0d0d;
  position: relative;
  cursor: default;
}
.segment {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  padding: 8px 4px;
  border-right: 1px solid #333;
  font-size: 11px;
  color: #aaa;
  text-align: center;
  cursor: pointer;
  position: relative;
  transition: background 0.1s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 0;
}
.segment:hover { background: #1a1a1a; }
.segment.selected { background: #1a2a3a; border-color: #2a5a8a; }
.segment .seg-time {
  position: absolute;
  bottom: 2px;
  left: 4px;
  font-size: 9px;
  color: #444;
}
.segment .seg-label {
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Status colors */
.segment.status-pending { border-top: 2px solid #555; }
.segment.status-prompted { border-top: 2px solid #a80; }
.segment.status-generated { border-top: 2px solid #08a; }
.segment.status-approved { border-top: 2px solid #0a0; }

/* Detail panel */
#detail-panel {
  display: none;
  padding: 16px;
  border-top: 1px solid #222;
  background: #0d0d0d;
}
#detail-panel h3 {
  font-size: 13px;
  color: #888;
  margin-bottom: 8px;
}
#detail-panel .detail-row {
  margin-bottom: 8px;
}
#detail-panel .detail-row label {
  display: block;
  font-size: 11px;
  color: #555;
  margin-bottom: 2px;
}
#detail-panel .detail-row textarea,
#detail-panel .detail-row input {
  width: 100%;
  background: #111;
  border: 1px solid #333;
  color: #e0e0e0;
  padding: 6px;
  font-family: inherit;
  font-size: 12px;
}
#detail-panel .detail-row textarea { min-height: 60px; }
#detail-panel .actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}
#detail-panel .actions button {
  background: #222;
  border: 1px solid #333;
  color: #ccc;
  padding: 6px 16px;
  cursor: pointer;
  font-family: inherit;
  font-size: 12px;
}
#detail-panel .actions button:hover { background: #333; }
#detail-panel .actions button.primary {
  background: #1a3a1a;
  border-color: #2a5a2a;
  color: #6c6;
}
#detail-panel .actions button.primary:hover { background: #2a4a2a; }

/* Keyframe preview */
#keyframe-preview {
  margin-top: 12px;
  max-width: 320px;
}
#keyframe-preview img {
  max-width: 100%;
  border: 1px solid #333;
}

/* Annotation bar */
#annotation-bar {
  padding: 8px 16px;
  display: none;
  background: #0a0a0a;
  border-top: 1px solid #1a1a1a;
}
#annotation-bar textarea {
  width: 100%;
  background: #111;
  border: 1px solid #333;
  color: #e0e0e0;
  padding: 6px;
  font-family: inherit;
  font-size: 12px;
  min-height: 40px;
}

/* Log */
#log {
  padding: 8px 16px;
  font-size: 11px;
  color: #444;
  border-top: 1px solid #111;
  max-height: 120px;
  overflow-y: auto;
}
#log .entry { padding: 1px 0; }
#log .entry.error { color: #a44; }
#log .entry.info { color: #4a4; }

/* Drop zone */
#drop-zone {
  border: 2px dashed #333;
  padding: 24px;
  text-align: center;
  color: #555;
  margin: 12px 0;
  cursor: pointer;
}
#drop-zone.dragover { border-color: #666; color: #888; }

/* Suno picker */
#suno-picker {
  padding: 16px 24px;
  border-bottom: 1px solid #222;
  background: #0d0d0d;
}
#suno-picker h3 {
  font-size: 13px;
  color: #888;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
}
#suno-picker h3 button {
  background: #222;
  border: 1px solid #333;
  color: #ccc;
  padding: 4px 12px;
  font-size: 11px;
  cursor: pointer;
}
#suno-picker h3 button:hover { background: #333; }
#suno-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 8px;
  max-height: 400px;
  overflow-y: auto;
}
.suno-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  background: #111;
  border: 1px solid #222;
  cursor: pointer;
  transition: all 0.1s;
}
.suno-card:hover { background: #1a1a1a; border-color: #333; }
.suno-card.selected { background: #1a2a1a; border-color: #3a5a3a; }
.suno-card img {
  width: 48px;
  height: 48px;
  object-fit: cover;
  border-radius: 4px;
  background: #222;
}
.suno-card .info {
  flex: 1;
  min-width: 0;
}
.suno-card .title {
  font-size: 12px;
  color: #ddd;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.suno-card .meta {
  font-size: 10px;
  color: #666;
  margin-top: 2px;
}
.suno-card .play-btn {
  width: 32px;
  height: 32px;
  background: #222;
  border: 1px solid #333;
  border-radius: 50%;
  color: #888;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.suno-card .play-btn:hover { background: #333; color: #fff; }
.suno-card .select-btn {
  background: #1a3a1a;
  border: 1px solid #2a5a2a;
  color: #6c6;
  padding: 4px 10px;
  font-size: 11px;
  cursor: pointer;
}
.suno-card .select-btn:hover { background: #2a4a2a; }
.suno-card .star-btn {
  background: none;
  border: none;
  font-size: 16px;
  cursor: pointer;
  color: #444;
  padding: 4px;
}
.suno-card .star-btn:hover { color: #a80; }
.suno-card .star-btn.starred { color: #fb0; }
.suno-card .note-btn {
  background: none;
  border: none;
  font-size: 12px;
  cursor: pointer;
  color: #444;
  padding: 4px;
}
.suno-card .note-btn:hover { color: #08a; }
.suno-card .note-btn.has-note { color: #0af; }
.suno-card.starred { border-color: #553; background: #1a1a10; }
.suno-card .note-preview {
  font-size: 9px;
  color: #666;
  margin-top: 2px;
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.note-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.note-modal-content {
  background: #111;
  border: 1px solid #333;
  padding: 16px;
  width: 400px;
  max-width: 90%;
}
.note-modal-content h4 {
  color: #888;
  font-size: 13px;
  margin-bottom: 12px;
}
.note-modal-content textarea {
  width: 100%;
  background: #0a0a0a;
  border: 1px solid #333;
  color: #e0e0e0;
  padding: 8px;
  font-family: inherit;
  font-size: 12px;
  min-height: 100px;
  resize: vertical;
}
.note-modal-content .modal-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: flex-end;
}
.note-modal-content button {
  background: #222;
  border: 1px solid #333;
  color: #ccc;
  padding: 6px 16px;
  font-size: 12px;
  cursor: pointer;
}
.note-modal-content button:hover { background: #333; }
.note-modal-content button.primary {
  background: #1a3a1a;
  border-color: #2a5a2a;
  color: #6c6;
}
#suno-loading {
  color: #555;
  padding: 20px;
  text-align: center;
}
#suno-preview-audio {
  width: 100%;
  height: 32px;
  margin-top: 8px;
}

/* Style reference anchor */
#style-anchor {
  padding: 16px 24px;
  border-bottom: 1px solid #222;
  background: #0a0a0a;
  display: none;
}
#style-anchor h3 {
  font-size: 13px;
  color: #888;
  margin-bottom: 12px;
}
#style-anchor-content {
  display: flex;
  gap: 16px;
  align-items: flex-start;
}
#style-anchor-image {
  width: 200px;
  min-height: 120px;
  background: #111;
  border: 2px dashed #333;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #555;
  font-size: 11px;
  cursor: pointer;
  position: relative;
}
#style-anchor-image img {
  max-width: 100%;
  max-height: 200px;
}
#style-anchor-image.has-image {
  border-style: solid;
  border-color: #3a5a3a;
}
#style-anchor-prompt {
  flex: 1;
}
#style-anchor-prompt textarea {
  width: 100%;
  background: #111;
  border: 1px solid #333;
  color: #e0e0e0;
  padding: 8px;
  font-family: inherit;
  font-size: 12px;
  min-height: 100px;
  resize: vertical;
}
#style-anchor-prompt label {
  display: block;
  font-size: 11px;
  color: #555;
  margin-bottom: 4px;
}
#style-anchor-prompt button {
  margin-top: 8px;
  background: #1a3a1a;
  border: 1px solid #2a5a2a;
  color: #6c6;
  padding: 6px 16px;
  font-size: 12px;
  cursor: pointer;
}
#style-anchor-prompt button:hover { background: #2a4a2a; }

/* Storyboard view */
#storyboard-view {
  padding: 16px 24px;
  display: none;
  max-height: 50vh;
  overflow-y: auto;
  background: #0a0a0a;
  border-bottom: 1px solid #222;
}
#storyboard-view h3 {
  font-size: 13px;
  color: #888;
  margin-bottom: 12px;
  position: sticky;
  top: 0;
  background: #0a0a0a;
  padding-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}
#copy-next-btn {
  background: #1a3a1a;
  border: 1px solid #2a5a2a;
  color: #6c6;
  padding: 4px 12px;
  font-size: 11px;
  cursor: pointer;
  border-radius: 3px;
}
#copy-next-btn:hover { background: #2a4a2a; }
#copy-next-btn:active { background: #3a5a3a; }
#copy-counter {
  font-size: 11px;
  color: #666;
}
.storyboard-scene {
  display: flex;
  gap: 12px;
  padding: 10px;
  margin-bottom: 8px;
  background: #111;
  border: 1px solid #222;
  border-left: 3px solid #555;
}
.storyboard-scene.status-approved { border-left-color: #0a0; }
.storyboard-scene.status-prompted { border-left-color: #a80; }
.storyboard-scene .scene-num {
  font-size: 11px;
  color: #555;
  min-width: 40px;
}
.storyboard-scene .scene-time {
  font-size: 10px;
  color: #444;
  min-width: 80px;
}
.storyboard-scene .scene-label {
  font-size: 12px;
  color: #aaa;
  flex: 1;
}
.storyboard-scene .scene-desc {
  font-size: 11px;
  color: #666;
  flex: 2;
}
.storyboard-scene .copy-btn {
  background: #222;
  border: 1px solid #333;
  color: #888;
  padding: 3px 8px;
  font-size: 10px;
  cursor: pointer;
  border-radius: 2px;
  white-space: nowrap;
}
.storyboard-scene .copy-btn:hover { background: #333; color: #aaa; }
.storyboard-scene .copy-btn.copied { background: #1a3a1a; color: #6c6; border-color: #2a5a2a; }
.storyboard-scene.just-copied { background: #1a2a1a; }
</style>
</head>
<body>

<div id="topbar">
  <h1>musicvid</h1>
  <span class="song-title" id="song-title">—</span>
  <div id="step-indicators"></div>
</div>

<div id="toolbar">
  <button id="btn-setup" class="tool-btn">Setup</button>
  <button id="btn-style" class="tool-btn">Style Anchor</button>
  <button id="btn-view-storyboard" class="tool-btn">View Storyboard</button>
  <button id="btn-gen-storyboard" class="tool-btn action-btn">Generate New Storyboard</button>
  <button id="btn-slice" class="tool-btn action-btn">Slice to 6s</button>
  <button id="btn-view-prompts" class="tool-btn">View Prompts</button>
  <button id="btn-gen-prompts" class="tool-btn action-btn">Generate Prompts</button>
  <button id="btn-stitch" class="tool-btn action-btn">Stitch Video</button>
</div>

<div id="audio-bar">
  <audio id="audio-player" controls></audio>
  <span class="time" id="audio-time">0:00 / 0:00</span>
</div>

<div id="suno-picker">
  <h3>
    Pick from Suno Library
    <button id="btn-load-suno">Load Songs</button>
    <button id="btn-load-more-suno" style="display:none">Load More</button>
    <button id="btn-show-cookie" style="margin-left:auto">Set Cookie</button>
  </h3>
  <div id="cookie-input" style="display:none;margin-bottom:12px">
    <input id="inp-suno-cookie" type="text" placeholder="Paste cookie from browser console: copy(document.cookie)" style="width:100%;background:#111;border:1px solid #333;color:#e0e0e0;padding:8px;font-family:inherit;font-size:11px">
    <button id="btn-save-cookie" style="margin-top:6px;background:#1a3a1a;border:1px solid #2a5a2a;color:#6c6;padding:4px 12px;font-size:11px;cursor:pointer">Save Cookie</button>
    <span style="font-size:10px;color:#555;margin-left:8px">Run in suno.com console: copy(document.cookie)</span>
  </div>
  <div id="suno-grid"></div>
  <audio id="suno-preview-audio" style="display:none" controls></audio>
</div>

<div id="style-anchor">
  <h3>Style Reference Anchor (used for consistent img2img generation)</h3>
  <div id="style-anchor-content">
    <div id="style-anchor-image">
      <span>Drop image or click</span>
    </div>
    <input type="file" id="style-anchor-input" accept="image/*" style="display:none">
    <div id="style-anchor-prompt">
      <label>Style Prompt (describes the visual style for all keyframes)</label>
      <textarea id="inp-style-prompt" placeholder="e.g. cinematic wide shot, warm golden hour lighting, oil painting style, rich saturated colors, dramatic shadows..."></textarea>
      <button id="btn-save-style-anchor">Save Style Anchor</button>
    </div>
  </div>
</div>

<div id="storyboard-view">
  <h3>
    Storyboard (<span id="scene-count">0</span> scenes)
    <button id="copy-next-btn">Copy Prompt #1</button>
    <span id="copy-counter"></span>
  </h3>
  <div id="storyboard-list"></div>
</div>

<div id="setup-panel">
  <h2>Song Setup</h2>
  <label>Song Title</label>
  <input id="inp-title" placeholder="e.g. Midnight Horizon">
  <div class="row">
    <div>
      <label>Artist</label>
      <input id="inp-artist" placeholder="e.g. Suno AI">
    </div>
    <div>
      <label>Style / Genre</label>
      <input id="inp-style" placeholder="e.g. psychedelic rock, Indian fusion">
    </div>
  </div>
  <div class="row">
    <div>
      <label>BPM (optional)</label>
      <input id="inp-bpm" type="number" placeholder="120">
    </div>
    <div>
      <label>Duration (seconds, optional)</label>
      <input id="inp-duration" type="number" placeholder="180">
    </div>
  </div>
  <label>Lyrics</label>
  <textarea id="inp-lyrics" placeholder="Paste full lyrics here..."></textarea>
  <label>Audio File</label>
  <div id="drop-zone">Drop audio file here or click to select</div>
  <input type="file" id="file-input" accept="audio/*" style="display:none">
  <div style="margin-top:16px">
    <button id="btn-save-setup" style="background:#1a3a1a;border:1px solid #2a5a2a;color:#6c6;padding:8px 24px;cursor:pointer;font-family:inherit">Save &amp; Continue</button>
  </div>
</div>

<div id="timeline-container">
  <div id="timeline-label">Timeline — click a segment to edit</div>
  <div id="timeline"></div>
</div>

<div id="detail-panel">
  <h3 id="detail-title">Segment</h3>
  <div class="detail-row">
    <label>Label</label>
    <input id="detail-label">
  </div>
  <div class="detail-row">
    <label>Description</label>
    <textarea id="detail-desc"></textarea>
  </div>
  <div class="detail-row">
    <label>Art Prompt</label>
    <textarea id="detail-prompt"></textarea>
  </div>
  <div class="detail-row">
    <label>Annotation (human notes)</label>
    <textarea id="detail-annotation" placeholder="e.g. sounds like a sitar raga here"></textarea>
  </div>
  <div id="keyframe-preview"></div>
  <div class="actions">
    <button class="primary" id="btn-approve-seg">Approve</button>
    <button id="btn-save-seg">Save</button>
    <button id="btn-split-seg">Split Here</button>
    <button id="btn-merge-seg">Merge Right</button>
  </div>
</div>

<div id="log"></div>

<script>
// --- State ---
let project = {};
let scenes = [];
let selectedIdx = -1;
let ws = null;

// --- DOM refs ---
const $ = (sel) => document.querySelector(sel);
const $timeline = $('#timeline');
const $detail = $('#detail-panel');
const $timelineContainer = $('#timeline-container');
const $setupPanel = $('#setup-panel');
const $audioBar = $('#audio-bar');
const $audioPlayer = $('#audio-player');

// --- WebSocket ---
function connectWs() {
  ws = new WebSocket(`ws://${location.host}`);
  ws.onopen = () => log('connected', 'info');
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'scenes-updated') loadScenes();
    if (msg.type === 'project-updated') loadProject();
    if (msg.type === 'timeline-updated') loadScenes();
    if (msg.type === 'pipeline-status') handlePipelineStatus(msg);
    if (msg.type === 'pipeline-log') log(msg.message.trim(), 'info');
  };
  ws.onclose = () => { log('disconnected, reconnecting...'); setTimeout(connectWs, 2000); };
}

// --- API helpers ---
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(`/api/${path}`, opts);
  return res.json();
}

// --- Project ---
async function loadProject() {
  project = await api('GET', 'project');
  $('#song-title').textContent = project.title || '—';
  $('#inp-title').value = project.title || '';
  $('#inp-artist').value = project.artist || '';
  $('#inp-style').value = project.style || '';
  $('#inp-lyrics').value = project.lyrics || '';
  $('#inp-bpm').value = project.bpm || '';
  $('#inp-duration').value = project.duration || '';
  if (project.audioFile) {
    $audioBar.style.display = 'flex';
    $audioPlayer.src = `/project/${project.audioFile}`;
  }
  if (project.stage && project.stage !== 'init') {
    $setupPanel.style.display = 'none';
    $timelineContainer.style.display = 'block';
    loadScenes();
  }
  updateStepIndicators();
}

function updateStepIndicators() {
  const steps = [
    { id: 'song', label: 'Song', done: !!project.audioFile },
    { id: 'style', label: 'Style', done: !!project.stylePrompt || !!project.styleAnchorImage },
    { id: 'storyboard', label: 'Storyboard', done: scenes.length > 0 },
    { id: 'prompts', label: 'Prompts', done: scenes.some(s => s.prompt) },
    { id: 'keyframes', label: 'Keyframes', done: scenes.some(s => s.keyframe) },
    { id: 'video', label: 'Video', done: project.stage === 'done' }
  ];

  const container = $('#step-indicators');
  container.innerHTML = steps.map(s =>
    `<span class="step-indicator ${s.done ? 'done' : ''}">${s.label}</span>`
  ).join('');
}

async function saveProject() {
  project.title = $('#inp-title').value;
  project.artist = $('#inp-artist').value;
  project.style = $('#inp-style').value;
  project.lyrics = $('#inp-lyrics').value;
  project.bpm = parseInt($('#inp-bpm').value) || null;
  project.duration = parseInt($('#inp-duration').value) || null;
  await api('POST', 'project', project);
  log('project saved', 'info');
}

// --- Scenes ---
async function loadScenes() {
  scenes = await api('GET', 'scenes');
  renderTimeline();
  updateStepIndicators();
}

async function saveScenes() {
  await api('POST', 'scenes', scenes);
  renderTimeline();
}

function renderTimeline() {
  $timeline.innerHTML = '';
  if (!scenes.length) {
    // If no scenes yet but we have lyrics, show a placeholder
    if (project.lyrics) {
      buildInitialScenes();
      return;
    }
    $timeline.innerHTML = '<div style="padding:16px;color:#555">No scenes yet. Set up song and click Transcribe.</div>';
    return;
  }

  const totalDuration = scenes.reduce((s, sc) => s + (sc.end - sc.start), 0) || 1;
  const containerWidth = Math.max(window.innerWidth - 32, totalDuration * 12);

  scenes.forEach((sc, i) => {
    const seg = document.createElement('div');
    seg.className = `segment status-${sc.status || 'pending'}`;
    const dur = sc.end - sc.start;
    seg.style.width = `${Math.max(60, (dur / totalDuration) * containerWidth)}px`;
    seg.innerHTML = `
      <span class="seg-label">${sc.label || sc.description?.slice(0, 20) || `scene ${i + 1}`}</span>
      <span class="seg-time">${fmtTime(sc.start)}-${fmtTime(sc.end)}</span>
    `;
    if (i === selectedIdx) seg.classList.add('selected');
    seg.addEventListener('click', () => selectSegment(i));
    $timeline.appendChild(seg);
  });
}

function buildInitialScenes() {
  // Create one big scene from lyrics as a starting point
  const dur = project.duration || 180;
  const lines = project.lyrics.split('\n').filter(l => l.trim());
  const perLine = dur / lines.length;
  scenes = lines.map((line, i) => ({
    label: line.slice(0, 30),
    description: line,
    start: +(i * perLine).toFixed(2),
    end: +((i + 1) * perLine).toFixed(2),
    status: 'pending',
    prompt: '',
    annotation: ''
  }));
  saveScenes();
}

// --- Segment selection ---
function selectSegment(idx) {
  selectedIdx = idx;
  const sc = scenes[idx];
  if (!sc) return;
  $detail.style.display = 'block';
  $('#detail-title').textContent = `Scene ${idx + 1} — ${fmtTime(sc.start)} to ${fmtTime(sc.end)}`;
  $('#detail-label').value = sc.label || '';
  $('#detail-desc').value = sc.description || '';
  $('#detail-prompt').value = sc.prompt || '';
  $('#detail-annotation').value = sc.annotation || '';
  // Show keyframe if exists
  const kfDiv = $('#keyframe-preview');
  if (sc.keyframe) {
    kfDiv.innerHTML = `<img src="/project/keyframes/${sc.keyframe}" alt="keyframe">`;
  } else {
    kfDiv.innerHTML = '';
  }
  renderTimeline();

  // Seek audio to segment start
  if ($audioPlayer.src && !isNaN(sc.start)) {
    $audioPlayer.currentTime = sc.start;
  }
}

// --- Segment actions ---
$('#btn-save-seg').addEventListener('click', () => {
  if (selectedIdx < 0) return;
  scenes[selectedIdx].label = $('#detail-label').value;
  scenes[selectedIdx].description = $('#detail-desc').value;
  scenes[selectedIdx].prompt = $('#detail-prompt').value;
  scenes[selectedIdx].annotation = $('#detail-annotation').value;
  saveScenes();
  log('segment saved', 'info');
});

$('#btn-approve-seg').addEventListener('click', () => {
  if (selectedIdx < 0) return;
  scenes[selectedIdx].status = 'approved';
  scenes[selectedIdx].label = $('#detail-label').value;
  scenes[selectedIdx].description = $('#detail-desc').value;
  scenes[selectedIdx].prompt = $('#detail-prompt').value;
  scenes[selectedIdx].annotation = $('#detail-annotation').value;
  saveScenes();
  log(`scene ${selectedIdx + 1} approved`, 'info');
});

$('#btn-split-seg').addEventListener('click', () => {
  if (selectedIdx < 0) return;
  const sc = scenes[selectedIdx];
  const mid = (sc.start + sc.end) / 2;
  const left = { ...sc, end: +mid.toFixed(2), label: sc.label + ' (a)' };
  const right = { ...sc, start: +mid.toFixed(2), label: sc.label + ' (b)', status: 'pending', prompt: '' };
  scenes.splice(selectedIdx, 1, left, right);
  saveScenes();
  log('segment split', 'info');
});

$('#btn-merge-seg').addEventListener('click', () => {
  if (selectedIdx < 0 || selectedIdx >= scenes.length - 1) return;
  const a = scenes[selectedIdx];
  const b = scenes[selectedIdx + 1];
  a.end = b.end;
  a.label = a.label + ' + ' + b.label;
  a.description = (a.description || '') + ' ' + (b.description || '');
  a.status = 'pending';
  scenes.splice(selectedIdx + 1, 1);
  saveScenes();
  log('segments merged', 'info');
});

// --- Setup ---
$('#btn-save-setup').addEventListener('click', async () => {
  await saveProject();
  if (project.lyrics) {
    project.stage = 'setup';
    await api('POST', 'project', project);
    $setupPanel.style.display = 'none';
    $timelineContainer.style.display = 'block';
    loadScenes();
  }
});

$('#btn-setup').addEventListener('click', () => {
  hideAllPanels();
  $setupPanel.style.display = 'block';
  setActiveToolBtn('btn-setup');
});

$('#btn-style').addEventListener('click', () => {
  hideAllPanels();
  $styleAnchor.style.display = 'block';
  setActiveToolBtn('btn-style');
});

$('#btn-view-storyboard').addEventListener('click', () => {
  hideAllPanels();
  $timelineContainer.style.display = 'block';
  $('#storyboard-view').style.display = 'block';
  renderStoryboardView();
  setActiveToolBtn('btn-view-storyboard');
});

$('#btn-view-prompts').addEventListener('click', () => {
  hideAllPanels();
  $timelineContainer.style.display = 'block';
  renderStoryboardView();
  // Select first scene with a prompt to show it
  const idx = scenes.findIndex(s => s.prompt);
  if (idx >= 0) selectSegment(idx);
  setActiveToolBtn('btn-view-prompts');
});

function hideAllPanels() {
  $setupPanel.style.display = 'none';
  $styleAnchor.style.display = 'none';
  $timelineContainer.style.display = 'none';
  $('#storyboard-view').style.display = 'none';
  $detail.style.display = 'none';
}

function setActiveToolBtn(id) {
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById(id);
  if (btn) btn.classList.add('active');
}

// --- Audio upload ---
const dropZone = $('#drop-zone');
const fileInput = $('#file-input');
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleAudioFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => handleAudioFile(fileInput.files[0]));

async function handleAudioFile(file) {
  if (!file) return;
  dropZone.textContent = `Uploading ${file.name}...`;
  const res = await fetch('/api/upload-audio', {
    method: 'POST',
    headers: { 'Content-Type': file.type },
    body: file
  });
  const data = await res.json();
  project.audioFile = data.path;
  dropZone.textContent = `Uploaded: ${data.path}`;
  $audioBar.style.display = 'flex';
  $audioPlayer.src = `/project/${data.path}`;
  log('audio uploaded', 'info');
}

// --- Audio time tracking ---
$audioPlayer.addEventListener('timeupdate', () => {
  const cur = $audioPlayer.currentTime;
  const dur = $audioPlayer.duration || 0;
  $('#audio-time').textContent = `${fmtTime(cur)} / ${fmtTime(dur)}`;

  // Highlight current segment
  if (scenes.length) {
    const idx = scenes.findIndex(s => cur >= s.start && cur < s.end);
    if (idx >= 0 && idx !== selectedIdx) {
      // Just highlight, don't auto-select (too disruptive)
      document.querySelectorAll('.segment').forEach((el, i) => {
        el.classList.toggle('playing', i === idx);
      });
    }
  }
});

// --- Pipeline buttons ---
let pipelineRunning = false;

function handlePipelineStatus(msg) {
  const { stage, status, message } = msg;
  log(`[${stage}] ${message}`, status === 'error' ? 'error' : 'info');

  if (status === 'done' || status === 'error') {
    pipelineRunning = false;
    // Reset button states
    $('#btn-gen-storyboard').textContent = 'Generate New Storyboard';
    $('#btn-gen-storyboard').disabled = false;
    $('#btn-gen-prompts').textContent = 'Generate Prompts';
    $('#btn-gen-prompts').disabled = false;
    $('#btn-stitch').textContent = 'Stitch Video';
    $('#btn-stitch').disabled = false;

    // Show storyboard view after storyboard generation
    if (stage === 'storyboard' && status === 'done') {
      loadScenes().then(() => {
        hideAllPanels();
        $timelineContainer.style.display = 'block';
        $('#storyboard-view').style.display = 'block';
        renderStoryboardView();
        setActiveToolBtn('btn-view-storyboard');
        updateStepIndicators();
      });
    }

    // Update indicators after prompts
    if (stage === 'prompts' && status === 'done') {
      loadScenes().then(() => {
        renderStoryboardView();
        updateStepIndicators();
      });
    }
  }
}

$('#btn-gen-storyboard').addEventListener('click', async () => {
  if (pipelineRunning) return;

  // Confirm if storyboard already exists
  if (scenes.length > 0) {
    if (!confirm(`This will replace the existing ${scenes.length} scenes. Continue?`)) return;
  }

  pipelineRunning = true;
  $('#btn-gen-storyboard').textContent = 'Generating...';
  $('#btn-gen-storyboard').disabled = true;
  log('Starting storyboard generation...', 'info');
  try {
    await fetch('/api/pipeline/storyboard', { method: 'POST' });
  } catch (e) {
    log('Failed to start storyboard: ' + e.message, 'error');
    pipelineRunning = false;
    $('#btn-gen-storyboard').textContent = 'Generate New Storyboard';
    $('#btn-gen-storyboard').disabled = false;
  }
});

$('#btn-slice').addEventListener('click', () => {
  // Auto-slice scenes to max 6 seconds
  const maxDur = 6;
  const newScenes = [];
  for (const sc of scenes) {
    const dur = sc.end - sc.start;
    if (dur <= maxDur) {
      newScenes.push(sc);
    } else {
      const n = Math.ceil(dur / maxDur);
      const segDur = dur / n;
      for (let i = 0; i < n; i++) {
        newScenes.push({
          ...sc,
          start: +(sc.start + i * segDur).toFixed(2),
          end: +(sc.start + (i + 1) * segDur).toFixed(2),
          label: `${sc.label} (${i + 1}/${n})`,
          status: 'pending',
          prompt: ''
        });
      }
    }
  }
  scenes = newScenes;
  saveScenes();
  log(`sliced to ${scenes.length} scenes (max ${maxDur}s each)`, 'info');
});

$('#btn-gen-prompts').addEventListener('click', async () => {
  if (pipelineRunning) return;

  // Confirm if prompts already exist
  const hasPrompts = scenes.some(s => s.prompt);
  if (hasPrompts) {
    if (!confirm('This will replace existing prompts. Continue?')) return;
  }

  pipelineRunning = true;
  $('#btn-gen-prompts').textContent = 'Generating...';
  $('#btn-gen-prompts').disabled = true;
  log('Starting prompt generation...', 'info');
  try {
    await fetch('/api/pipeline/gen-prompts', { method: 'POST' });
  } catch (e) {
    log('Failed to start prompt generation: ' + e.message, 'error');
    pipelineRunning = false;
    $('#btn-gen-prompts').textContent = 'Generate Prompts';
    $('#btn-gen-prompts').disabled = false;
  }
});

$('#btn-stitch').addEventListener('click', async () => {
  if (pipelineRunning) return;
  pipelineRunning = true;
  $('#btn-stitch').textContent = 'Stitching...';
  $('#btn-stitch').disabled = true;
  log('Starting video stitching...', 'info');
  try {
    await fetch('/api/pipeline/stitch', { method: 'POST' });
  } catch (e) {
    log('Failed to start stitching: ' + e.message, 'error');
    pipelineRunning = false;
    $('#btn-stitch').textContent = 'Stitch';
    $('#btn-stitch').disabled = false;
  }
});

// --- Utilities ---
function fmtTime(s) {
  if (isNaN(s)) return '0:00';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${m}:${sec.toString().padStart(2, '0')}`;
}

function log(msg, cls = '') {
  const el = document.createElement('div');
  el.className = `entry ${cls}`;
  el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  $('#log').prepend(el);
}

// --- Suno Picker ---
let sunoSongs = [];
let sunoPage = 0;
const $sunoGrid = $('#suno-grid');
const $sunoPreview = $('#suno-preview-audio');

// LocalStorage for stars and notes
function getSongMeta() {
  try {
    return JSON.parse(localStorage.getItem('sunoSongMeta') || '{}');
  } catch { return {}; }
}
function saveSongMeta(meta) {
  localStorage.setItem('sunoSongMeta', JSON.stringify(meta));
}
function isStarred(id) {
  return getSongMeta()[id]?.starred || false;
}
function toggleStar(id) {
  const meta = getSongMeta();
  if (!meta[id]) meta[id] = {};
  meta[id].starred = !meta[id].starred;
  saveSongMeta(meta);
  return meta[id].starred;
}
function getNote(id) {
  return getSongMeta()[id]?.note || '';
}
function setNote(id, note) {
  const meta = getSongMeta();
  if (!meta[id]) meta[id] = {};
  meta[id].note = note;
  saveSongMeta(meta);
}

$('#btn-load-suno').addEventListener('click', () => loadSunoSongs(0));
$('#btn-load-more-suno').addEventListener('click', () => loadSunoSongs(sunoPage + 1));

$('#btn-show-cookie').addEventListener('click', () => {
  const el = $('#cookie-input');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
});

$('#btn-save-cookie').addEventListener('click', async () => {
  const cookie = $('#inp-suno-cookie').value.trim();
  if (!cookie) return;
  try {
    const res = await fetch('/api/suno/cookie', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cookie })
    });
    if (res.ok) {
      log('Suno cookie saved', 'info');
      $('#cookie-input').style.display = 'none';
      $('#inp-suno-cookie').value = '';
      loadSunoSongs(0);
    } else {
      const err = await res.json();
      log('Cookie save failed: ' + err.error, 'error');
    }
  } catch (e) {
    log('Cookie save error: ' + e.message, 'error');
  }
});

async function loadSunoSongs(page = 0) {
  $sunoGrid.innerHTML = '<div id="suno-loading">Loading songs from Suno...</div>';
  try {
    const res = await fetch(`/api/suno/songs?page=${page}`);
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || `HTTP ${res.status}`);
    }
    const data = await res.json();
    const songs = data.clips || data.songs || data || [];

    if (page === 0) {
      sunoSongs = songs;
    } else {
      sunoSongs = sunoSongs.concat(songs);
    }
    sunoPage = page;

    renderSunoGrid();
    $('#btn-load-more-suno').style.display = songs.length >= 20 ? 'inline-block' : 'none';
    log(`loaded ${sunoSongs.length} songs from Suno`, 'info');
  } catch (e) {
    $sunoGrid.innerHTML = `<div id="suno-loading" style="color:#a44">Error: ${e.message}</div>`;
    log(`suno error: ${e.message}`, 'error');
  }
}

function renderSunoGrid() {
  $sunoGrid.innerHTML = '';

  // Sort: starred first
  const sorted = [...sunoSongs].sort((a, b) => {
    const aStarred = isStarred(a.id) ? 1 : 0;
    const bStarred = isStarred(b.id) ? 1 : 0;
    return bStarred - aStarred;
  });

  for (const song of sorted) {
    const card = document.createElement('div');
    card.className = 'suno-card';
    if (isStarred(song.id)) card.classList.add('starred');
    card.dataset.id = song.id;

    const imgUrl = song.image_url || song.image_large_url || '';
    const title = song.title || 'Untitled';
    const dur = song.duration ? `${Math.round(song.duration)}s` : '';
    const style = (song.metadata?.tags || '').slice(0, 40);
    const note = getNote(song.id);

    card.innerHTML = `
      <img src="${imgUrl}" alt="" onerror="this.style.display='none'">
      <div class="info">
        <div class="title">${escHtml(title)}</div>
        <div class="meta">${dur} ${style ? '· ' + escHtml(style) : ''}</div>
        ${note ? `<div class="note-preview">${escHtml(note.slice(0, 50))}</div>` : ''}
      </div>
      <button class="star-btn ${isStarred(song.id) ? 'starred' : ''}" title="Star">&#9733;</button>
      <button class="note-btn ${note ? 'has-note' : ''}" title="Add note">&#9998;</button>
      <button class="play-btn" title="Preview">&#9658;</button>
      <button class="select-btn">Use</button>
    `;

    const starBtn = card.querySelector('.star-btn');
    const noteBtn = card.querySelector('.note-btn');
    const playBtn = card.querySelector('.play-btn');
    const selectBtn = card.querySelector('.select-btn');

    starBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const starred = toggleStar(song.id);
      starBtn.classList.toggle('starred', starred);
      card.classList.toggle('starred', starred);
      // Re-render to re-sort
      renderSunoGrid();
    });

    noteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showNoteModal(song.id, title);
    });

    playBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (song.audio_url) {
        $sunoPreview.src = song.audio_url;
        $sunoPreview.style.display = 'block';
        $sunoPreview.play();
        // Highlight current
        document.querySelectorAll('.suno-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
      }
    });

    selectBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      selectBtn.textContent = 'Loading...';
      selectBtn.disabled = true;
      try {
        const res = await fetch(`/api/suno/select/${song.id}`, { method: 'POST' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        log(`selected: ${song.title}`, 'info');
        // Hide picker and reload project
        loadProject();
      } catch (e) {
        log(`select error: ${e.message}`, 'error');
        selectBtn.textContent = 'Use';
        selectBtn.disabled = false;
      }
    });

    $sunoGrid.appendChild(card);
  }
}

function showNoteModal(songId, songTitle) {
  const existing = getNote(songId);
  const modal = document.createElement('div');
  modal.className = 'note-modal';
  modal.innerHTML = `
    <div class="note-modal-content">
      <h4>Notes for: ${escHtml(songTitle)}</h4>
      <textarea id="note-textarea" placeholder="Add your notes about this song...">${escHtml(existing)}</textarea>
      <div class="modal-actions">
        <button id="note-cancel">Cancel</button>
        <button id="note-save" class="primary">Save</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector('#note-cancel').addEventListener('click', () => modal.remove());
  modal.querySelector('#note-save').addEventListener('click', () => {
    const note = modal.querySelector('#note-textarea').value;
    setNote(songId, note);
    modal.remove();
    renderSunoGrid();
    log('Note saved', 'info');
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });

  modal.querySelector('#note-textarea').focus();
}

function escHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// --- Style Anchor ---
const $styleAnchor = $('#style-anchor');
const $styleAnchorImage = $('#style-anchor-image');
const $styleAnchorInput = $('#style-anchor-input');

$styleAnchorImage.addEventListener('click', () => $styleAnchorInput.click());
$styleAnchorImage.addEventListener('dragover', (e) => { e.preventDefault(); });
$styleAnchorImage.addEventListener('drop', (e) => {
  e.preventDefault();
  handleStyleAnchorImage(e.dataTransfer.files[0]);
});
$styleAnchorInput.addEventListener('change', () => handleStyleAnchorImage($styleAnchorInput.files[0]));

async function handleStyleAnchorImage(file) {
  if (!file) return;
  const formData = new FormData();
  formData.append('image', file);

  // Show preview immediately
  const reader = new FileReader();
  reader.onload = (e) => {
    $styleAnchorImage.innerHTML = `<img src="${e.target.result}" alt="style anchor">`;
    $styleAnchorImage.classList.add('has-image');
  };
  reader.readAsDataURL(file);

  // Upload to server
  try {
    const res = await fetch('/api/upload-style-anchor', {
      method: 'POST',
      headers: { 'Content-Type': file.type },
      body: file
    });
    const data = await res.json();
    project.styleAnchorImage = data.path;
    log('style anchor image uploaded', 'info');
  } catch (e) {
    log('upload error: ' + e.message, 'error');
  }
}

$('#btn-save-style-anchor').addEventListener('click', async () => {
  project.stylePrompt = $('#inp-style-prompt').value;
  await api('POST', 'project', project);
  log('style anchor saved', 'info');
});

function loadStyleAnchor() {
  if (project.styleAnchorImage) {
    $styleAnchorImage.innerHTML = `<img src="/project/${project.styleAnchorImage}" alt="style anchor">`;
    $styleAnchorImage.classList.add('has-image');
  }
  if (project.stylePrompt) {
    $('#inp-style-prompt').value = project.stylePrompt;
  }
}

// --- Storyboard View ---
let copyIndex = 0;

function updateCopyNextBtn() {
  const btn = $('#copy-next-btn');
  const counter = $('#copy-counter');
  if (copyIndex < scenes.length) {
    btn.textContent = `Copy Prompt #${copyIndex + 1}`;
    btn.disabled = false;
    counter.textContent = `${copyIndex}/${scenes.length} copied`;
  } else {
    btn.textContent = 'All copied!';
    btn.disabled = true;
    counter.textContent = `${scenes.length}/${scenes.length} done`;
  }
}

async function copyPromptAtIndex(idx) {
  const sc = scenes[idx];
  if (!sc) return;

  const text = sc.prompt || sc.description || '';
  try {
    await navigator.clipboard.writeText(text);
    log(`Copied prompt #${idx + 1} to clipboard`, 'info');

    // Flash the row
    const rows = document.querySelectorAll('.storyboard-scene');
    rows.forEach(r => r.classList.remove('just-copied'));
    if (rows[idx]) {
      rows[idx].classList.add('just-copied');
      rows[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
      const copyBtn = rows[idx].querySelector('.copy-btn');
      if (copyBtn) {
        copyBtn.classList.add('copied');
        copyBtn.textContent = 'Copied!';
      }
    }

    // Update index to next
    copyIndex = idx + 1;
    updateCopyNextBtn();
  } catch (e) {
    log('Copy failed: ' + e.message, 'error');
  }
}

$('#copy-next-btn').addEventListener('click', () => {
  if (copyIndex < scenes.length) {
    copyPromptAtIndex(copyIndex);
  }
});

function renderStoryboardView() {
  const $view = $('#storyboard-view');
  const $list = $('#storyboard-list');

  if (!scenes.length) {
    $view.style.display = 'none';
    return;
  }

  $view.style.display = 'block';
  $('#scene-count').textContent = scenes.length;
  updateCopyNextBtn();

  $list.innerHTML = '';
  scenes.forEach((sc, i) => {
    const hasPrompt = !!sc.prompt;
    const div = document.createElement('div');
    div.className = `storyboard-scene status-${sc.status || 'pending'}`;
    div.innerHTML = `
      <div class="scene-num">#${i + 1}</div>
      <div class="scene-time">${fmtTime(sc.start)} - ${fmtTime(sc.end)}</div>
      <div class="scene-label">${escHtml(sc.label || '')}</div>
      <div class="scene-desc">${escHtml((sc.description || '').slice(0, 100))}</div>
      <button class="copy-btn" data-idx="${i}">${hasPrompt ? 'Copy' : 'No prompt'}</button>
    `;

    const copyBtn = div.querySelector('.copy-btn');
    if (hasPrompt) {
      copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        copyPromptAtIndex(i);
      });
    } else {
      copyBtn.disabled = true;
    }

    div.addEventListener('click', () => {
      selectSegment(i);
      $timelineContainer.scrollIntoView({ behavior: 'smooth' });
    });
    $list.appendChild(div);
  });
}

// --- Init ---
connectWs();
loadProject().then(() => {
  loadStyleAnchor();
  // Default view based on project state
  if (project.stage === 'init' || !project.audioFile) {
    // Show song picker (already visible by default)
  } else if (scenes.length > 0) {
    hideAllPanels();
    $timelineContainer.style.display = 'block';
    $('#storyboard-view').style.display = 'block';
    renderStoryboardView();
    setActiveToolBtn('btn-view-storyboard');
  } else if (project.stylePrompt || project.styleAnchorImage) {
    hideAllPanels();
    $styleAnchor.style.display = 'block';
    setActiveToolBtn('btn-style');
  }
});

// Auto-load Suno songs on page load
loadSunoSongs(0);

// Add playing style
const style = document.createElement('style');
style.textContent = '.segment.playing { background: #1a1a0a !important; }';
document.head.appendChild(style);
</script>
</body>
</html>
